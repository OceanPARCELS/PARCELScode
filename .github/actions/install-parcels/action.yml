name: Setup Conda and install parcels
description: >
  In-repo composite action to setup micromamba and install parcels. For general setup of Anaconda environments, you can also use
  the `conda-incubator/setup-miniconda` action (setting C variables as required).
inputs:
  environment-file:
    description: Conda environment file to use.
    default: environment.yml
  python-version:
    description: Python version to use.
    default: ""
runs:
  using: "composite"
  steps:
    - name: Set environment variables
      shell: bash -l {0}
      run: |
        echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
    - name: Configure pagefile # Windows compatability fix as per PR #1279
      if: ${{ runner.os == 'Windows' }}
      uses: al-cheb/configure-pagefile-action@v1.3
      with:
        minimum-size: 8GB
    - name: Setup micromamba
      uses: mamba-org/setup-micromamba@v2
      with:
        environment-file: ${{ inputs.environment-file }}
        environment-name: parcels-dev
        cache-environment: true
        cache-environment-key: "${{runner.os}}-${{runner.arch}}-py${{inputs.python-version}}-${{env.TODAY}}-${{hashFiles(inputs.environment-file)}}"
        create-args: >-
          python=${{inputs.python-version}}
    - name: MPI support
      if: ${{ ! (runner.os == 'Windows') }}
      run: micromamba install -c conda-forge mpich mpi4py -y
      shell: bash -el {0}
    - name: Install parcels
      run: pip install .
      shell: bash -el {0}
